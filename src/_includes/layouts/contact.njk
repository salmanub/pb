{% extends "layouts/base.njk" %}

{% block content %}
<main class="contact-page">
    {# Hero Section con dos columnas visibles en todas las pantallas - Estilos ya consistentes #}
    <header class="relative pt-36 pb-24 md:pt-40 md:pb-28 flex items-center bg-gradient-to-br from-[#0B1030] to-[#1a2452] text-white overflow-hidden min-h-[60vh] md:min-h-[50vh]">
        <div class="relative z-10 w-full">
            {# Centrado en pantallas grandes #}
            <div class="w-full px-4 sm:px-8 md:px-12 lg:px-0 md:w-[95%] max-w-[1400px] mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    {# Columna izquierda - Info principal #}
                    <div class="space-y-6">
                        <span class="flex justify-center md:justify-start items-center text-sm md:text-base font-semibold tracking-[2px] uppercase text-cyan-400">
                            <span class="hidden md:block w-8 h-0.5 bg-cyan-400 mr-3"></span>
                            CONTACTO
                        </span>
                        
                        <h1 class="text-[2.5rem] md:text-[3.5rem] font-light leading-[1.1] text-center md:text-left">
                            HABLEMOS DE 
                            <strong class="block text-cyan-400 mt-4">TU PROYECTO</strong>
                        </h1>
                        
                        <p class="text-lg md:text-xl text-cyan-50 font-light max-w-3xl mx-auto md:mx-0 text-center md:text-left">
                            Si necesitas un informe pericial para un problema de construcci칩n o una disputa con tu seguro, estamos aqu칤 para ayudarte.
                        </p>
                    </div>
                    
                    {# Contacto r치pido en hero - Columna derecha, visible siempre #}
                    <div class="space-y-6">
                        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 border border-white/10">
                            <h3 class="text-xl font-medium text-white mb-4 text-center md:text-left">Contacto Directo</h3>
                            <div class="space-y-4">
                                <a href="tel:+34932123456" class="flex items-center gap-3 p-3 bg-white/5 hover:bg-white/10 rounded-xl transition-colors group">
                                    <svg class="w-6 h-6 text-cyan-400 group-hover:scale-110 transition-transform flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                    <div>
                                        <div class="text-white font-medium">+34 932 123 456</div>
                                        {# Horario actualizado #}
                                        <p class="text-xs text-white/70">L-J: 9-18h | V: 9-14h</p>
                                    </div>
                                </a>
                                
                                <a href="mailto:info@perito.barcelona" class="flex items-center gap-3 p-3 bg-white/5 hover:bg-white/10 rounded-xl transition-colors group">
                                    <svg class="w-6 h-6 text-cyan-400 group-hover:scale-110 transition-transform flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    <div>
                                        <div class="text-white font-medium">info@perito.barcelona</div>
                                        <p class="text-xs text-white/70">Respuesta en < 24h</p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {# Patr칩n de fondo #}
        <div class="absolute inset-0 bg-grid-pattern opacity-10"></div>
    </header>

    {# Contenido Principal - 2 Columnas con Typeform y Mapas - Estilos homogeneizados #}
    {# Aplicando gradiente de fondo similar a secciones home #}
    <section class="py-24 -mt-8 relative z-10 bg-gradient-to-br from-slate-50 via-white to-slate-100">
        <div class="max-w-[1400px] mx-auto px-4 md:px-8">
            {# Grid con gap consistente #}
            <div class="grid lg:grid-cols-2 items-start lg:items-stretch gap-12 lg:gap-16">
                {# Columna Izquierda - Formulario estilo Typeform (Primero en m칩vil) #}
                <div class="order-1">
                    {# Estilos de card consistentes con home (bg, shadow, border, padding, rounded) #}
                    <div class="bg-white rounded-2xl shadow-lg p-8 lg:p-12 border border-slate-100 hover:shadow-xl transition-shadow duration-300 h-full flex flex-col">
                        {# Encabezado descriptivo para el formulario - Estilos de texto home #}
                        <div class="mb-10 text-center lg:text-left">
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-3">Consulta Online Detallada</h2>
                            <p class="text-lg text-slate-600">Rellena los pasos para darnos m치s informaci칩n sobre tu caso.</p>
                        </div>
                        
                        {# Contenedor Typeform #}
                        <div id="typeform-container" class="space-y-16 flex-grow flex flex-col justify-between">
                            {# Introducci칩n - Estilos de texto y bot칩n home #}
                            <div class="typeform-step active space-y-6" data-step="intro">
                                <h3 class="text-2xl font-light text-slate-800">游녦 Cu칠ntanos sobre tu caso</h3>
                                <p class="text-lg text-slate-600">Te asesoraremos sin compromiso y te ofreceremos una primera valoraci칩n gratuita.</p>
                                {# Bot칩n estilo home #}
                                <button class="typeform-next mt-6 px-8 py-4 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 transition-colors duration-300 group flex items-center gap-2">
                                    Comenzar
                                    <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                    </svg>
                                </button>
                            </div>
                            
                            {# Paso 1: Nombre - Estilos de texto, input y botones home #}
                            <div class="typeform-step hidden space-y-8" data-step="nombre">
                                <div class="space-y-2">
                                    <h3 class="text-xl font-light text-slate-800">쮺u치l es tu nombre?</h3>
                                    <p class="text-slate-500 text-sm">Esta informaci칩n es necesaria para poder atenderte personalmente</p>
                                </div>
                                <input 
                                    type="text" 
                                    name="nombre" 
                                    class="w-full px-0 py-4 text-xl bg-transparent border-0 border-b-2 border-slate-200 focus:ring-0 focus:border-cyan-500 transition-colors placeholder-slate-400" 
                                    placeholder="Escribe tu nombre completo aqu칤"
                                    required>
                                <div class="pt-6 flex justify-between items-center">
                                    {# Bot칩n atr치s estilo sutil #}
                                    <button class="typeform-prev px-5 py-2 text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                        Atr치s
                                    </button>
                                    {# Bot칩n continuar estilo home #}
                                    <button class="typeform-next px-6 py-3 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 transition-colors duration-300 group flex items-center gap-2 text-sm">
                                        Continuar
                                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            {# Paso 2: Email - Estilos consistentes #}
                            <div class="typeform-step hidden space-y-8" data-step="email">
                                <div class="space-y-2">
                                    <h3 class="text-xl font-light text-slate-800">쮸 qu칠 correo electr칩nico podemos contactarte?</h3>
                                    <p class="text-slate-500 text-sm">Te enviaremos nuestra valoraci칩n a este email</p>
                                </div>
                                <input 
                                    type="email" 
                                    name="email" 
                                    class="w-full px-0 py-4 text-xl bg-transparent border-0 border-b-2 border-slate-200 focus:ring-0 focus:border-cyan-500 transition-colors placeholder-slate-400" 
                                    placeholder="tu@email.com"
                                    required>
                                <div class="pt-6 flex justify-between items-center">
                                    <button class="typeform-prev px-5 py-2 text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                        Atr치s
                                    </button>
                                    <button class="typeform-next px-6 py-3 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 transition-colors duration-300 group flex items-center gap-2 text-sm">
                                        Continuar
                                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            {# Paso 3: Tel칠fono - Estilos consistentes #}
                            <div class="typeform-step hidden space-y-8" data-step="telefono">
                                <div class="space-y-2">
                                    <h3 class="text-xl font-light text-slate-800">쮺u치l es tu n칰mero de tel칠fono?</h3>
                                    <p class="text-slate-500 text-sm">Opcional, pero 칰til para poder contactarte m치s r치pidamente</p>
                                </div>
                                <input 
                                    type="tel" 
                                    name="telefono" 
                                    class="w-full px-0 py-4 text-xl bg-transparent border-0 border-b-2 border-slate-200 focus:ring-0 focus:border-cyan-500 transition-colors placeholder-slate-400" 
                                    placeholder="+34 000 000 000">
                                <div class="pt-6 flex justify-between items-center">
                                    <button class="typeform-prev px-5 py-2 text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                        Atr치s
                                    </button>
                                    <button class="typeform-next px-6 py-3 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 transition-colors duration-300 group flex items-center gap-2 text-sm">
                                        Continuar
                                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            {# Paso 4: Mensaje - Estilos consistentes #}
                            <div class="typeform-step hidden space-y-8" data-step="mensaje">
                                <div class="space-y-2">
                                    <h3 class="text-xl font-light text-slate-800">Cu칠ntanos un poco sobre tu caso</h3>
                                    <p class="text-slate-500 text-sm">쯈u칠 tipo de problema tienes? 쮺u치ndo comenz칩? 쮿as intentado solucionarlo?</p>
                                </div>
                                <textarea 
                                    name="mensaje" 
                                    rows="4" 
                                    class="w-full px-0 py-4 text-xl bg-transparent border-0 border-b-2 border-slate-200 focus:ring-0 focus:border-cyan-500 transition-colors placeholder-slate-400"
                                    placeholder="Describe brevemente tu situaci칩n..."
                                    required></textarea>
                                <div class="pt-6 flex justify-between items-center">
                                    <button class="typeform-prev px-5 py-2 text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                        Atr치s
                                    </button>
                                    <button class="typeform-next px-6 py-3 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 transition-colors duration-300 group flex items-center gap-2 text-sm">
                                        Continuar
                                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            {# Paso 5: Privacidad y Env칤o - Estilos consistentes #}
                            <div class="typeform-step hidden space-y-8" data-step="privacidad">
                                <div class="space-y-2">
                                    <h3 class="text-xl font-light text-slate-800">칔ltimo paso</h3>
                                    <p class="text-slate-500 text-sm">Para poder procesar tu consulta, necesitamos que aceptes nuestra pol칤tica de privacidad</p>
                                </div>
                                <div class="flex items-start gap-3 py-4">
                                    <input 
                                        type="checkbox" 
                                        id="privacidad" 
                                        name="privacidad" 
                                        required 
                                        class="mt-1.5 w-5 h-5 rounded border-slate-300 text-cyan-600 focus:ring-cyan-500 cursor-pointer">
                                    <label for="privacidad" class="text-slate-600 cursor-pointer text-sm"> {/* Ajustado tama침o texto */}
                                        He le칤do y acepto la <a href="/privacidad" class="text-cyan-600 hover:underline font-medium">Pol칤tica de Privacidad</a> y el tratamiento de mis datos.
                                    </label>
                                </div>
                                <div class="pt-6 flex justify-between items-center">
                                    <button class="typeform-prev px-5 py-2 text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                        Atr치s
                                    </button>
                                    {# Bot칩n Enviar estilo home #}
                                    <button type="submit" form="contactForm" class="px-8 py-4 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 transition-colors duration-300 group flex items-center gap-2">
                                        Enviar Consulta
                                        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            

                            {# Progreso - Estilo barra home #}
                            <div class="mt-6 w-full bg-slate-200 h-1.5 rounded-full overflow-hidden"> {/* M치s grueso y color base */}
                                <div id="typeform-progress" class="bg-cyan-500 h-full w-0 transition-all duration-300"></div>
                            </div>
                        </div>
                        
                        <form id="contactForm" class="hidden" method="POST">
                            <input type="hidden" name="nombre" id="form-nombre">
                            <input type="hidden" name="email" id="form-email">
                            <input type="hidden" name="telefono" id="form-telefono">
                            <input type="hidden" name="mensaje" id="form-mensaje">
                            <input type="hidden" name="privacidad" id="form-privacidad">
                        </form>
                    </div>
                </div>

                {# Columna Derecha - Tabs de ubicaciones (Segundo en m칩vil) #}
                <div class="order-2">
                    {# Sticky wrapper #}
                    <div class="sticky top-24 space-y-8">
                        {# Encabezado descriptivo para las ubicaciones - Estilos home #}
                        <div class="text-center lg:text-left">
                             <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-3">Nuestras Oficinas</h2>
                             <p class="text-lg text-slate-600">Vis칤tanos en Barcelona o Granollers.</p>
                        </div>
                        
                        {# Ubicaciones con tabs para mapas - Estilos card home #}
                        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border border-slate-100 flex flex-col">
                            {# Tabs de ubicaciones - Estilos botones home #}
                            <div class="tabs-header flex border-b border-slate-200">
                                <button id="tab-barcelona" class="tab-btn flex-1 px-5 py-4 font-semibold text-slate-800 bg-white border-b-2 border-cyan-500 focus:outline-none group transition-colors duration-200" onclick="switchTab('barcelona')">
                                    <div class="flex items-center justify-center gap-3">
                                        <svg class="w-5 h-5 text-cyan-500 group-hover:scale-110 transition-transform flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span>Barcelona</span>
                                    </div>
                                </button>
                                <button id="tab-granollers" class="tab-btn flex-1 px-5 py-4 font-semibold text-slate-500 bg-slate-50 border-b-2 border-transparent hover:bg-slate-100 focus:outline-none group transition-colors duration-200" onclick="switchTab('granollers')">
                                    <div class="flex items-center justify-center gap-3">
                                        <svg class="w-5 h-5 text-cyan-500 group-hover:scale-110 transition-transform flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span>Granollers</span>
                                    </div>
                                </button>
                            </div>
                            
                            {# Contenido de las tabs #}
                            <div class="tabs-content flex-grow">
                                <div id="content-barcelona" class="tab-content h-full flex flex-col">
                                    {# Info direcci칩n/horario - Estilos home #}
                                    <div class="p-6 lg:p-8 bg-white">
                                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
                                            <div>
                                                <p class="text-lg font-bold text-slate-800 mb-1">Barcelona</p>
                                                <p class="text-slate-600">C/ Numancia 95, Local 5</p>
                                                <p class="text-sm text-slate-500 mt-1">Metro L5 Enten칞a</p>
                                            </div>
                                            <div class="md:pl-4 md:border-l md:border-slate-200 flex-shrink-0 mt-4 md:mt-0">
                                                <p class="text-sm font-semibold text-slate-700">Horario</p>
                                                <p class="text-sm text-slate-600">L-J: 9-18h | V: 9-14h</p>
                                                <p class="text-xs text-slate-500 mt-1">* Visitas con cita previa</p>
                                            </div>
                                        </div>
                                    </div>
                                    {# Mapa #}
                                    <div class="h-[300px] flex-grow">
                                        <div id="map-barcelona" class="w-full h-full"></div>
                                    </div>
                                </div>
                                
                                <div id="content-granollers" class="tab-content hidden h-full flex flex-col">
                                    {# Info direcci칩n/horario - Estilos home #}
                                    <div class="p-6 lg:p-8 bg-white">
                                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
                                            <div>
                                                <p class="text-lg font-bold text-slate-800 mb-1">Granollers</p>
                                                <p class="text-slate-600">C/ Navarra 14</p>
                                                <p class="text-sm text-slate-500 mt-1">Cerca estaci칩n Renfe</p>
                                            </div>
                                            <div class="md:pl-4 md:border-l md:border-slate-200 flex-shrink-0 mt-4 md:mt-0">
                                                <p class="text-sm font-semibold text-slate-700">Horario</p>
                                                <p class="text-sm text-slate-600">L-J: 9-18h | V: 9-14h</p>
                                                <p class="text-xs text-slate-500 mt-1">* Visitas con cita previa</p>
                                            </div>
                                        </div>
                                    </div>
                                    {# Mapa #}
                                    <div class="h-[300px] flex-grow">
                                        <div id="map-granollers" class="w-full h-full"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {# CTA Final con estilos adaptados al sitio - Ya consistente #}
    <section class="py-24 px-4 md:px-[5%] bg-gradient-to-br from-slate-100 via-white to-slate-50 relative overflow-hidden">
        {# Overlay decorativo con gradientes #}
        <div class="absolute inset-0">
            <div class="absolute inset-0 bg-gradient-to-br from-cyan-50/30 via-transparent to-slate-100/20"></div>
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(0,0,0,.02)_0%,transparent_50%)] mix-blend-overlay"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-white/50 to-transparent"></div>
        </div>
        
        <div class="max-w-[1400px] mx-auto relative z-10 text-center">
            <div class="max-w-3xl mx-auto">
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6">쯇refieres hablar directamente?</h3>
                <p class="text-lg md:text-xl text-slate-600 mb-10">Ll치manos ahora y te atenderemos personalmente para resolver tus dudas.</p>
                <a href="tel:+34932123456" class="inline-flex items-center justify-center px-8 py-4 bg-gradient-to-r from-cyan-500 to-cyan-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl hover:shadow-cyan-500/25 transition-all group text-lg">
                    <svg class="w-5 h-5 mr-3 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                    Llamar al +34 932 123 456
                </a>
            </div>
        </div>
    </section>
</main>

<script>
    // Add smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });

    // Typeform functionality
    document.addEventListener('DOMContentLoaded', function() {
        const steps = document.querySelectorAll('.typeform-step');
        const progress = document.getElementById('typeform-progress');
        const hiddenForm = document.getElementById('contactForm');
        let currentStep = 0;

        function goToNextStep() {
            // Validar campo actual si es requerido
            const currentStepEl = steps[currentStep];
            const input = currentStepEl.querySelector('input:not([type="checkbox"]), textarea');
            const nextButton = currentStepEl.querySelector('.typeform-next'); // Get the next button for the current step

            // Check if input exists and is required but empty
            if (input && input.required && !input.value.trim()) {
                input.classList.add('border-red-500');
                input.focus();
                // Remove red border on input change
                input.addEventListener('input', () => input.classList.remove('border-red-500'), { once: true });
                return; // Stop if validation fails
            } else if (input) {
                 input.classList.remove('border-red-500'); // Ensure border is removed if valid
            }

            // Si es el checkbox de privacidad
            if (currentStepEl.dataset.step === 'privacidad') {
                const checkbox = currentStepEl.querySelector('input[type="checkbox"]');
                if (checkbox.required && !checkbox.checked) {
                    // Maybe add some visual feedback for the checkbox
                    const label = currentStepEl.querySelector('label[for="privacidad"]');
                    if (label) {
                        label.classList.add('text-red-600');
                        checkbox.addEventListener('change', () => label.classList.remove('text-red-600'), { once: true });
                    }
                    return; // Stop if privacy not checked
                } else {
                     const label = currentStepEl.querySelector('label[for="privacidad"]');
                     if (label) label.classList.remove('text-red-600');
                }
            }

            // Guardar valor en form oculto (only if input exists)
            if (input) {
                const formInputId = `form-${currentStepEl.dataset.step}`;
                const formInput = document.getElementById(formInputId);
                if (formInput) {
                    if (input.type === 'checkbox') {
                        formInput.value = input.checked ? 'si' : 'no';
                    } else {
                        formInput.value = input.value;
                    }
                } else {
                    console.warn(`Hidden form input with id ${formInputId} not found.`);
                }
            }
             // Handle checkbox separately for hidden form
            if (currentStepEl.dataset.step === 'privacidad') {
                 const checkbox = currentStepEl.querySelector('input[type="checkbox"]');
                 const formInput = document.getElementById('form-privacidad');
                 if (checkbox && formInput) {
                     formInput.value = checkbox.checked ? 'si' : 'no';
                 }
            }


            // Avanzar al siguiente paso
            steps[currentStep].classList.remove('active');
            steps[currentStep].classList.add('hidden');
            currentStep++;

            if (currentStep < steps.length) {
                steps[currentStep].classList.add('active');
                steps[currentStep].classList.remove('hidden');

                // Actualizar progreso
                const progressPercentage = (currentStep / (steps.length - 1)) * 100;
                progress.style.width = `${progressPercentage}%`;

                // Autofocus en el nuevo input/textarea
                const newInput = steps[currentStep].querySelector('input:not([type="checkbox"]), textarea');
                if (newInput) {
                    setTimeout(() => newInput.focus(), 300); // Delay focus slightly for transition
                }
                 // Add Enter key listener to the new input
                addEnterKeyListener(steps[currentStep]);

            } else {
                 // If it was the last step, and we clicked next (which is submit), the form should submit
                 // This case is handled by the submit button's default behavior or an explicit submit handler if added later.
                 console.log("Reached end of steps or submitting form.");
                 // Potentially trigger form submission if needed, though the button type="submit" should handle it.
                 // hiddenForm.submit();
            }
        }

        function goToPrevStep() {
             if (currentStep > 0) {
                steps[currentStep].classList.remove('active');
                steps[currentStep].classList.add('hidden');
                currentStep--;
                steps[currentStep].classList.add('active');
                steps[currentStep].classList.remove('hidden');

                // Actualizar progreso
                const progressPercentage = (currentStep / (steps.length - 1)) * 100;
                progress.style.width = `${progressPercentage}%`;

                 // Autofocus on the input of the previous step
                 const prevInput = steps[currentStep].querySelector('input:not([type="checkbox"]), textarea');
                 if (prevInput) {
                     setTimeout(() => prevInput.focus(), 300);
                 }
                 // Re-add Enter key listener if needed (though it should persist)
                 addEnterKeyListener(steps[currentStep]);
            }
        }

        // Add Enter key listener function
        function addEnterKeyListener(stepElement) {
            const input = stepElement.querySelector('input:not([type="checkbox"]):not([type="tel"]), textarea'); // Exclude tel for now, Enter might be used differently
            const nextButton = stepElement.querySelector('.typeform-next');
            const submitButton = stepElement.querySelector('button[type="submit"]');

            if (input) {
                input.removeEventListener('keydown', handleEnterKey); // Remove previous listener if any
                input.addEventListener('keydown', handleEnterKey);
            }
             // Special handling for tel input if needed
             const telInput = stepElement.querySelector('input[type="tel"]');
             if (telInput) {
                 telInput.removeEventListener('keydown', handleEnterKey);
                 telInput.addEventListener('keydown', handleEnterKey);
             }
        }

        // Handler for Enter key
        function handleEnterKey(event) {
            // Check if Enter key was pressed and it's not Shift+Enter (for textarea)
            if (event.key === 'Enter' && !event.shiftKey) {
                 event.preventDefault(); // Prevent default form submission or newline in textarea

                 // Find the correct button (Next or Submit) for the current step
                 const currentStepEl = steps[currentStep];
                 const nextButton = currentStepEl.querySelector('.typeform-next');
                 const submitButton = currentStepEl.querySelector('button[type="submit"]');

                 if (submitButton) {
                     // If there's a submit button, click it (handles validation within its click)
                     // Need to check privacy checkbox validation before clicking submit
                     if (currentStepEl.dataset.step === 'privacidad') {
                         const checkbox = currentStepEl.querySelector('input[type="checkbox"]');
                         if (checkbox.required && !checkbox.checked) {
                             event.preventDefault(); // Prevent submission if checkbox not checked
                             const label = currentStepEl.querySelector('label[for="privacidad"]');
                             if (label) {
                                 label.classList.add('text-red-600');
                                 checkbox.addEventListener('change', () => label.classList.remove('text-red-600'), { once: true });
                             }
                         } else {
                             const label = currentStepEl.querySelector('label[for="privacidad"]');
                             if (label) label.classList.remove('text-red-600');
                         }
                     }
                     submitButton.click();
                 } else if (nextButton) {
                     // Otherwise, trigger the next step logic
                     goToNextStep(); // Use the function that includes validation
                 }
            }
        }


        // Initial setup for the first step
        addEnterKeyListener(steps[0]);


        // Botones para avanzar (Click)
        document.querySelectorAll('.typeform-next').forEach(btn => {
            btn.addEventListener('click', function(event) {
                 // Check if the button is NOT a submit button before calling goToNextStep
                 if (btn.getAttribute('type') !== 'submit') {
                     event.preventDefault(); // Prevent default if it's just a 'next' button
                     goToNextStep();
                 }
                 // If it IS a submit button, let the default form submission proceed after validation (handled by browser or submit handler)
                 // However, we need to ensure privacy checkbox is checked if required
                 else if (steps[currentStep].dataset.step === 'privacidad') {
                     const checkbox = steps[currentStep].querySelector('input[type="checkbox"]');
                     if (checkbox.required && !checkbox.checked) {
                         event.preventDefault(); // Prevent submission if checkbox not checked
                         const label = steps[currentStep].querySelector('label[for="privacidad"]');
                         if (label) {
                             label.classList.add('text-red-600');
                             checkbox.addEventListener('change', () => label.classList.remove('text-red-600'), { once: true });
                         }
                     } else {
                         // If checkbox is checked, transfer data to hidden form before submitting
                         const formInput = document.getElementById('form-privacidad');
                         if (checkbox && formInput) {
                             formInput.value = checkbox.checked ? 'si' : 'no';
                         }
                         // Also ensure other fields are transferred (might be redundant if done in goToNextStep, but safe)
                         steps.forEach((step, index) => {
                             if (index < currentStep) { // Only for steps before the final one
                                 const input = step.querySelector('input:not([type="checkbox"]), textarea');
                                 if (input) {
                                     const formInputId = `form-${step.dataset.step}`;
                                     const formInput = document.getElementById(formInputId);
                                     if (formInput) formInput.value = input.value;
                                 }
                             }
                         });
                     }
                 }
            });
        });

        // Botones para retroceder (Click)
        document.querySelectorAll('.typeform-prev').forEach(btn => {
            btn.addEventListener('click', function(event) {
                event.preventDefault(); // Always prevent default for previous buttons
                goToPrevStep();
            });
        });

         // Add listener for form submission success/failure if using AJAX later
         // hiddenForm.addEventListener('submit', function(e) { ... });
    });

    // Funcionalidad para las tabs de ubicaciones
    function switchTab(location) {
        // Ocultar todos los contenidos
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Mostrar el contenido seleccionado
        document.getElementById(`content-${location}`).classList.remove('hidden');
        
        // Actualizar estilos de los botones de tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('border-cyan-500', 'text-slate-800', 'bg-white');
            btn.classList.add('border-transparent', 'text-slate-500', 'bg-slate-50', 'hover:bg-slate-100'); // A침adido hover state para inactivos
        });
        
        // Resaltar el bot칩n activo
        const activeBtn = document.getElementById(`tab-${location}`);
        activeBtn.classList.remove('border-transparent', 'text-slate-500', 'bg-slate-50', 'hover:bg-slate-100');
        activeBtn.classList.add('border-cyan-500', 'text-slate-800', 'bg-white');
    }

    // Inicializar mapas para ambas ubicaciones cuando se carga la p치gina
    function initMaps() {
        // Mapa de Barcelona
        const mapBarcelona = new google.maps.Map(document.getElementById('map-barcelona'), {
            center: { lat: 41.385064, lng: 2.1385816 }, // Coordenadas de Barcelona
            zoom: 16
        });
        
        // Marcador para Barcelona
        new google.maps.Marker({
            position: { lat: 41.385064, lng: 2.1385816 },
            map: mapBarcelona,
            title: "Perito Barcelona - Calle Numancia 95"
        });
        
        // Mapa de Granollers
        const mapGranollers = new google.maps.Map(document.getElementById('map-granollers'), {
            center: { lat: 41.6082985, lng: 2.2862264 }, // Coordenadas de Granollers
            zoom: 16
        });
        
        // Marcador para Granollers
        new google.maps.Marker({
            position: { lat: 41.6082985, lng: 2.2862264 },
            map: mapGranollers,
            title: "Perito Barcelona - Calle Navarra 14"
        });
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMaps"></script>

{% endblock %}

{% block pageStyles %}
    {% set indexCSS %} {% include "dist/assets/styles/index.css" %} {% endset %}
    <style>
        {{ indexCSS | safe }}
    </style>
{% endblock %}

