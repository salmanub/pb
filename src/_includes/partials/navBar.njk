{% set currentLanguage = page.lang or lang %} 
{% set defaultLanguage = metadata.default_lang %}
{% set navPages = collections.langCollections[currentLanguage] | eleventyNavigation %}

{% macro renderNavListItem(entry) %}
    {% if not entry.notshow %}
        <li class="nav-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ entry.url }}"
               class="flex items-center gap-2 lg:text-slate-600 lg:hover:text-cyan-500 font-medium transition-colors text-sm
                      {% if entry.url == page.url %}lg:text-cyan-500{% endif %}
                      {% if entry.url == page.url %}text-cyan-500{% else %}text-white{% endif %}
                      lg:p-0 px-4 py-4 text-xl sm:text-2xl hover:text-cyan-500 hover:bg-white/5 rounded-lg"
               itemprop="url"
               {% if entry.url == page.url %}aria-current="page"{% endif %}>
                {% if entry.icon %}
                    <svg class="w-7 h-7 lg:w-5 lg:h-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        {{entry.icon | safe}}
                    </svg>
                {% endif %}
                <span itemprop="name" class="lg:text-[1.1rem]">{{ entry.title }}</span>
            </a>
        </li>
    {% endif %}
{% endmacro %}

<header id="mainHeader" class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-sm z-60 transition-all duration-300" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <div class="max-w-[1600px] mx-auto px-[5%]">
        <!-- Top Bar - Solo Desktop -->
        <div class="hidden lg:flex justify-end items-center h-10 border-b border-slate-100">
            <!-- Language Selector -->
            <div class="flex items-center gap-1.5 px-4 border-l border-slate-100">
                {% for language in metadata.languages %}
                    {% set translatedUrl = '/' %}
                    {% if translations and translations.length %}
                        {% for translation in translations %}
                            {% if translation.lang == language %}
                                {% set translatedUrl = translation.permalink %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    
                    <a href="{% if language == currentLanguage %}{{permalink}}{% else %}{{ translatedUrl }}{% endif %}" 
                       class="py-1 px-2.5 text-xs font-medium tracking-wider uppercase rounded-md {% if language == currentLanguage %}bg-gradient-to-br from-cyan-400 to-cyan-500 text-white hover:shadow-md hover:shadow-cyan-200{% else %}text-slate-500 hover:bg-slate-50 hover:text-cyan-500{% endif %} transition-all"
                       {% if language == currentLanguage %}aria-current="true"{% endif %}>
                        {{ language | upper }}
                    </a>
                {% endfor %}
            </div>

            <!-- CTAs -->
            <div class="flex items-center">
                <a href="tel:{{metadata.contact.phoneNumber}}" class="flex items-center gap-2 px-4 py-1.5 text-sm text-slate-500 hover:text-cyan-500 border-l border-slate-100 transition-all group" itemprop="url">
                    <svg class="w-4 h-4 text-cyan-400 group-hover:scale-110 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                    <span>{{metadata.contact.phoneNumber}}</span>
                </a>
                <a href="/contacto/" class="px-4 py-1.5 text-sm font-semibold text-white bg-gradient-to-br from-cyan-400 to-cyan-500 hover:shadow-md hover:shadow-cyan-200 border-l border-slate-100 transition-all" itemprop="url">
                    SOLICITAR PRESUPUESTO
                </a>
            </div>
        </div>

        <!-- Main Navigation -->
        <div class="flex justify-between items-center h-[70px] lg:h-20">
            <!-- Logo -->
            <a href="/" class="flex items-center gap-2 sm:gap-3 group hover:-translate-y-0.5 transition-transform duration-300" itemprop="url">
                <svg class="w-10 h-10 sm:w-11 sm:h-11 lg:w-12 lg:h-12 text-cyan-400 transition-all duration-300 filter group-hover:drop-shadow-[0_4px_8px_rgba(0,184,212,0.3)]"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 375 375"
                    preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <clipPath id="2717b77dc4">
                            <path
                                d="M 223.109375 37.496094 L 314.597656 37.496094 L 314.597656 337.6875 L 223.109375 337.6875 Z M 223.109375 37.496094"
                                clip-rule="nonzero"
                            />
                        </clipPath>

                        <clipPath id="9422b2d12e">
                            <path
                                d="M 314.597656 67.992188 L 314.597656 337.496094 L 223.109375 307 L 223.109375 37.496094 Z M 314.597656 67.992188"
                                clip-rule="nonzero"
                            />
                        </clipPath>

                        <clipPath id="b07c821656">
                            <path
                                d="M 146.625 37.496094 L 223.117188 37.496094 L 223.117188 249.945312 L 146.625 249.945312 Z M 146.625 37.496094"
                                clip-rule="nonzero"
                            />
                        </clipPath>

                        <clipPath id="55959a45ff">
                            <path
                                d="M 146.625 62.996094 L 146.625 249.945312 L 223.117188 224.449219 L 223.117188 37.496094 Z M 146.625 62.996094"
                                clip-rule="nonzero"
                            />
                        </clipPath>

                        <clipPath id="a83aa56b9b">
                            <path
                                d="M 112.101562 111.523438 L 177.742188 111.523438 L 177.742188 291.515625 L 112.101562 291.515625 Z M 112.101562 111.523438"
                                clip-rule="nonzero"
                            />
                        </clipPath>

                        <clipPath id="1c3af9afe2">
                            <path
                                d="M 177.742188 133.402344 L 177.742188 291.402344 L 112.101562 269.523438 L 112.101562 111.523438 Z M 177.742188 133.402344"
                                clip-rule="nonzero"
                            />
                        </clipPath>

                        <clipPath id="a2157cede2">
                            <path
                                d="M 60.398438 111.367188 L 112.109375 111.367188 L 112.109375 237.410156 L 60.398438 237.410156 Z M 60.398438 111.367188"
                                clip-rule="nonzero"
                            />
                        </clipPath>

                        <clipPath id="1adccc21aa">
                            <path
                                d="M 60.398438 128.75 L 60.398438 237.410156 L 112.109375 220.175781 L 112.109375 111.515625 Z M 60.398438 128.75"
                                clip-rule="nonzero"
                            />
                        </clipPath>
                    </defs>

                    <g clip-path="url(#2717b77dc4)">
                        <g clip-path="url(#9422b2d12e)">
                            <path
                                fill="currentColor"
                                d="M 314.597656 37.496094 L 314.597656 337.332031 L 223.109375 337.332031 L 223.109375 37.496094 Z M 314.597656 37.496094"
                                fill-opacity="1"
                                fill-rule="nonzero"
                            />
                        </g>
                    </g>

                    <g clip-path="url(#b07c821656)">
                        <g clip-path="url(#55959a45ff)">
                            <path
                                fill="currentColor"
                                d="M 146.625 249.945312 L 146.625 37.496094 L 223.117188 37.496094 L 223.117188 249.945312 Z M 146.625 249.945312"
                                fill-opacity="1"
                                fill-rule="nonzero"
                            />
                        </g>
                    </g>

                    <g clip-path="url(#a83aa56b9b)">
                        <g clip-path="url(#1c3af9afe2)">
                            <path
                                fill="currentColor"
                                d="M 177.742188 111.523438 L 177.742188 291.515625 L 112.101562 291.515625 L 112.101562 111.523438 Z M 177.742188 111.523438"
                                fill-opacity="1"
                                fill-rule="nonzero"
                            />
                        </g>
                    </g>

                    <g clip-path="url(#a2157cede2)">
                        <g clip-path="url(#1adccc21aa)">
                            <path
                                fill="currentColor"
                                d="M 60.398438 237.410156 L 60.398438 111.570312 L 112.109375 111.570312 L 112.109375 237.410156 Z M 60.398438 237.410156"
                                fill-opacity="1"
                                fill-rule="nonzero"
                            />
                        </g>
                    </g>
                </svg>
                <div class="flex flex-col">
                    <span class="text-base sm:text-lg lg:text-xl font-extrabold leading-tight text-slate-800 tracking-wide group-hover:text-cyan-500 transition-colors" itemprop="name">PERITO</span>
                    <span class="text-sm sm:text-base lg:text-lg font-semibold text-slate-500 tracking-wider group-hover:text-cyan-400 transition-colors">BARCELONA</span>
                </div>
            </a>

            <!-- Desktop Navigation -->
            <nav class="hidden lg:block" itemprop="hasPart" itemscope itemtype="https://schema.org/SiteNavigationElement">
                <ul class="flex items-center gap-6">
                    {%- for entry in navPages %}{{ renderNavListItem(entry) }}{%- endfor -%}
                    
                </ul>
            </nav>

            <!-- Hamburger Menu Button -->
            <button id="menuButton" class="lg:hidden flex flex-col justify-center items-center w-10 h-10 rounded-md bg-cyan-400 hover:bg-cyan-500 transition-all relative gap-1.5">
                <span class="w-5 h-0.5 bg-white transition-all duration-300 ease-out"></span>
                <span class="w-5 h-0.5 bg-white transition-all duration-300 ease-out"></span>
                <span class="w-5 h-0.5 bg-white transition-all duration-300 ease-out"></span>
            </button>
        </div>
    </div>
</header>

<!-- Mobile Menu -->
<div id="mobileMenu" class="fixed top-[70px] lg:top-[120px] inset-x-0 bottom-0 bg-gradient-to-br from-[#0B1030] to-[#1A1F45] transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
    <div class="max-w-[1600px] mx-auto px-[5%] flex-1 overflow-y-auto flex flex-col">
        <!-- Navigation -->
        <nav class="flex-1 flex items-stretch">
            <ul class="space-y-4 w-full flex flex-col justify-around py-8">
                {%- for entry in navPages %}{{ renderNavListItem(entry) }}{%- endfor -%}
            </ul>
        </nav>
    </div>

    <!-- Footer actions -->
    <div class="py-6 border-t border-white/10 bg-gradient-to-b from-transparent to-black/20">
        <!-- Language selector -->
        <div class="flex justify-center gap-4 px-4">
            {% for language in metadata.languages %}
                {% set translatedUrl = '/' %}
                {% if translations and translations.length %}
                    {% for translation in translations %}
                        {% if translation.lang == language %}
                            {% set translatedUrl = translation.permalink %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                
                <a href="{% if language == currentLanguage %}{{permalink}}{% else %}{{ translatedUrl }}{% endif %}" 
                   class="font-medium px-3 py-2 rounded-md transition-all {% if language == currentLanguage %}text-cyan-400 bg-white/10 shadow-inner{% else %}text-slate-400 hover:text-cyan-400 hover:bg-white/5{% endif %}"
                   {% if language == currentLanguage %}aria-current="true"{% endif %}>
                    {{ language | upper }}
                </a>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Botón flotante para hablar con un perito -->
<a href="tel:{{metadata.contact.phoneNumber}}" id="talkToExpert" class="fixed bottom-7 right-5 z-40 hidden md:flex items-center bg-gradient-to-r from-cyan-400 to-cyan-500 text-white py-3 px-6 rounded-full font-semibold shadow-lg hover:shadow-cyan-500/25 hover:-translate-y-0.5 transition-all">
    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
    </svg>
    Hablar con un perito
</a>

<style>
    #menuButton.active span:first-child {
        transform: translateY(8px) rotate(45deg);
    }
    #menuButton.active span:nth-child(2) {
        opacity: 0;
        transform: translateX(-10px);
    }
    #menuButton.active span:last-child {
        transform: translateY(-8px) rotate(-45deg);
    }
</style>

